generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                            Int           @id @default(autoincrement())
  access_level                  Int           @default(1)
  name                          String?
  surname                       String?
  mobile                        String?
  email                         String        @unique
  username                      String?       @unique
  password_hash                 String
  is_verified                   Boolean       @default(false)
  verification_token            String?       @db.VarChar(512)
  verification_token_expires_at DateTime?
  reset_token                   String?       @db.VarChar(512)
  reset_token_expires_at        DateTime?
  last_login_at                 DateTime?
  failed_login_attempts         Int           @default(0)
  status                        UserStatus    @default(inactive)
  createdAt                     DateTime      @default(now()) @map("created_at")
  updatedAt                     DateTime      @default(now()) @updatedAt @map("updated_at")
  stage                         Int           @default(0)
  sessions                      Session[]
  authLogs                      AuthLog[]
  // The Organization this user belongs to (Staff/Member)
  organizationId                Int?
  organization                  Organization? @relation("OrganizationMembers", fields: [organizationId], references: [id])
  // The Organization this user created/owns
  ownedOrganization             Organization? @relation("OrganizationOwner")
  @@map("users")
}


model Organization {
  id               Int            @id @default(autoincrement())
  name             String
  // The Single Owner of the Org
  ownerId          Int            @unique
  owner            User           @relation("OrganizationOwner", fields: [ownerId], references: [id])
  // All Users (including the owner, if desired) belonging to this Org
  members          User[]         @relation("OrganizationMembers")
  pricingPackageId Int
  pricingPackage   PricingPackage @relation(fields: [pricingPackageId], references: [id], onDelete: Cascade)
  settings         Json?          // For currency, regional preferences, manual mode toggles
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  // Logistics & Features
  //apiKeys          ApiKey[]
  @@map("organizations")
}



model Session {
  id          Int       @id @default(autoincrement())
  user        User      @relation(fields: [userId], references: [id])
  userId      Int       @map("user_id")
  token       String    @unique
  device_info String?   @map("device_info")
  ip_address  String?   @map("ip_address")
  is_revoked  Boolean   @default(false) @map("is_revoked")
  revoked_at  DateTime? @map("revoked_at")
  expires_at  DateTime  @map("expires_at")
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @updatedAt @map("updated_at")
  @@index([userId])
  @@index([token])
  @@index([expires_at])
  @@index([userId, is_revoked, expires_at], name: "idx_active_sessions")
  @@map("sessions")
}

model AuthLog {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int      @map("user_id")
  ip        String?  @map("ip_address")
  userAgent String?  @db.Text @map("user_agent")
  event     String   @map("action")
  createdAt DateTime @default(now()) @map("created_at")
  @@index([userId])
  @@index([createdAt])
  @@map("auth_logs")
}

enum UserStatus {
  inactive
  active
  locked
  suspended

  @@map("status")
}

enum PayoutStatus {
  pending
  paid
  failed
  @@map("payout_status")
}
